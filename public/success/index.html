<!DOCTYPE html>
<html lang="id" class="bg-[#1d1f2b] text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LYRA - Pembayaran Berhasil</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex items-center justify-center min-h-screen px-4">
  <div class="max-w-md w-full bg-[#2c2e3e] rounded-xl p-6 shadow-lg border border-purple-700 text-white text-sm">
    <div class="text-center">
      <img src="https://lottie.host/5b6828f6-c994-47ef-86f1-68cc16d2edac/1F0AiHyJzp.json" class="w-24 h-24 mx-auto mb-4" alt="Success" />
      <h1 class="text-2xl font-bold text-green-400 mb-2">Pembayaran Sukses! ğŸ‰</h1>
      <p class="text-gray-300 mb-4">Terima kasih sudah belanja di LYRA.</p>
    </div>
  <img src="/logo.png" alt="LYRA Logo" class="w-16 h-16 rounded-full border border-purple-500 mb-4" />
    <div class="bg-gray-800 rounded-lg p-4 space-y-2 mb-4">
      <p><strong>ğŸ“› Nama:</strong> <span id="buyerName"></span></p>
      <p><strong>ğŸ“± No. WA:</strong> <span id="buyerPhone"></span></p>
      <p><strong>ğŸ  Alamat:</strong> <span id="buyerAddress"></span></p>
      <p><strong>ğŸ›’ Item:</strong></p>
      <ul id="itemList"></ul>
      <p><strong>ğŸ’° Total:</strong> <span id="orderTotal"></span></p>
      <p class="text-yellow-400 text-xs mt-2">*Belum termasuk ongkir. Dibayar saat barang sampai.</p>
    </div>

    <div class="flex gap-3 justify-between">
      <a href="/" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded w-full text-center">ğŸ  Kembali Belanja</a>
      <a href="https://wa.me/6281234567890" target="_blank" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded w-full text-center">ğŸ’¬ Chat Admin</a>
    </div>
  </div>
<!-- Modal Error -->
<div id="errorModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-[#2c2e3e] text-white rounded-lg max-w-sm w-full p-6 text-center shadow-lg border border-red-500">
    <h2 class="text-xl font-bold mb-2 text-red-400">Oops! ğŸ˜¥</h2>
    <p id="errorMessage" class="text-sm text-gray-300">Order tidak ditemukan.</p>
    <button onclick="location.href='/'" class="mt-4 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-full">
      Kembali ke Beranda
    </button>
  </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-black/70 z-40 flex items-center justify-center">
  <div class="animate-spin rounded-full h-14 w-14 border-t-4 border-purple-500 border-opacity-50"></div>
</div>
</body>
</html>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
    authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
    storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
    appId: import.meta.env.VITE_FIREBASE_APP_ID,
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const orderCard = document.querySelector('.bg-gray-800');
  const spinner = document.getElementById('loadingSpinner');
  const errorModal = document.getElementById('errorModal');
  const errorMessage = document.getElementById('errorMessage');

  orderCard.style.display = 'none';

  const params = new URLSearchParams(location.search);
  const orderId = params.get("order_id");

  if (!orderId) {
    return showError("Order ID tidak ditemukan di URL.");
  }

  try {
    const docRef = doc(db, "orders", orderId);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      return showError("Order tidak ditemukan di database.");
    }

    const data = docSnap.data();

    // ğŸ§¾ User info
    document.getElementById('buyerName').textContent = data.user?.nama || '-';
    document.getElementById('buyerPhone').textContent = data.user?.no_wa || '-';
    document.getElementById('buyerAddress').textContent = data.user?.alamat || '-';

    // ğŸ›ï¸ Cart
    const itemList = document.getElementById('itemList');
    itemList.innerHTML = '';
    let total = 0;

    Object.values(data.cart || {}).forEach(item => {
      const qty = item.qty || 1;
      const name = item.name || 'Produk';
      const price = parseInt(item.price) || 0;
      total += qty * price;

      const li = document.createElement('li');
      li.textContent = `${qty}x ${name}`;
      itemList.appendChild(li);
    });

    document.getElementById('orderTotal').textContent = `Rp ${total.toLocaleString('id-ID')}`;
    spinner.remove();
    orderCard.style.display = 'block';

  } catch (err) {
    console.error(err);
    showError("Terjadi kesalahan saat memuat data.");
  }

  function showError(msg) {
    spinner.remove();
    errorModal.classList.remove('hidden');
    errorMessage.textContent = msg;
  }
</script>
